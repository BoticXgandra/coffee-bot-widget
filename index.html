<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffeeology Blog Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        /* All original styles are the same */
        #chat-launcher { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; transition: transform 0.2s ease-in-out; }
        #chat-launcher:hover { transform: scale(1.1); }
        #chat-widget-container { position: fixed; bottom: 100px; right: 25px; width: 375px; max-width: 90vw; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; z-index: 999; display: none; flex-direction: column; opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        #chat-widget-container.active { display: flex; opacity: 1; transform: translateY(0); }
        .widget-header { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
        .widget-header h3 { font-weight: bold; color: #333; }
        #close-widget-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #555; }
        .chat-messages { height: 400px; overflow-y: auto; }
        .message-bubble { max-width: 85%; word-wrap: break-word; }
        .user-message { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .bot-message { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .article-card { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border-left: 4px solid #8b4513; }
        .article-card a { color: #8b4513; font-weight: 600; }
        .chat-input { border: 2px solid #8b4513; border-radius: 25px; padding: 12px 20px; background: white; width: 100%; }
        .send-button { background: linear-gradient(135deg, #8b4513 0%, #d2691e 100%); border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; }
    </style>
</head>
<body style="background-color: transparent;">
    <div id="chat-launcher">
        <i class="fas fa-coffee text-white text-2xl"></i>
    </div>

    <div id="chat-widget-container">
        <div class="widget-header">
            <h3 class="text-gray-800">Coffeeology Assistant</h3>
            <button id="close-widget-btn" aria-label="Close Chat"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="p-4 flex-grow flex flex-col">
            <div class="chat-messages mb-4" id="chatMessages"></div>
            <div class="flex items-center space-x-3 mt-auto">
                <input type="text" id="userInput" placeholder="Ask about coffee..." class="flex-1 chat-input" onkeypress="handleKeyPress(event)">
                <button id="sendButton" class="send-button" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA AND CONFIG ---
        const SITEMAP = [ { url: 'https://coffeeologyblog.com/', title: 'Home' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-espresso-machines-2/', title: 'Best Coffee Beans for Espresso Machines' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-espresso-machines/', title: 'Best Coffee Beans for Espresso Machines' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-espresso-machines-3/', title: 'Best Coffee Beans for Espresso Machines' }, { url: 'https://coffeeologyblog.com/selecting-coffee-beans-for-home-brewing/', title: 'Selecting Coffee Beans for Home Brewing' }, { url: 'https://coffeeologyblog.com/best-espresso-machine-friendly-coffee-beans/', title: 'Best Espresso Machine Friendly Coffee Beans' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-home-brewing-mastery/', title: 'Best Coffee Beans for Home Brewing Mastery' }, { url: 'https://coffeeologyblog.com/best-5-coffee-beans-for-home-brewing-excellence/', title: 'Best 5 Coffee Beans for Home Brewing Excellence' }, { url: 'https://coffeeologyblog.com/organic-coffee-beans-for-coffee-makers-3/', title: 'Organic Coffee Beans for Coffee Makers' }, { url: 'https://coffeeologyblog.com/how-to-choose-coffee-beans-for-latte/', title: 'How to Choose Coffee Beans for Latte' }, { url: 'https://coffeeologyblog.com/organic-coffee-beans-for-coffee-makers-4/', title: 'Organic Coffee Beans for Coffee Makers' }, { url: 'https://coffeeologyblog.com/choosing-the-right-roast-for-coffee-machines/', title: 'Choosing the Right Roast for Coffee Machines' }, { url: 'https://coffeeologyblog.com/choosing-the-right-roast-for-coffee-machines-2/', title: 'Choosing the Right Roast for Coffee Machines' }, { url: 'https://coffeeologyblog.com/guide-to-coffee-bean-selection-for-cappuccino/', title: 'Guide to Coffee Bean Selection for Cappuccino' }, { url: 'https://coffeeologyblog.com/guide-to-coffee-bean-selection-for-cappuccino-2/', title: 'Guide to Coffee Bean Selection for Cappuccino' }, { url: 'https://coffeeologyblog.com/guide-to-coffee-bean-selection-for-cappuccino-3/', title: 'Guide to Coffee Bean Selection for Cappuccino' }, { url: 'https://coffeeologyblog.com/best-roasts-for-your-coffee-machine-selection/', title: 'Best Roasts for Your Coffee Machine Selection' }, { url: 'https://coffeeologyblog.com/comparing-coffee-beans-for-french-press/', title: 'Comparing Coffee Beans for French Press' }, { url: 'https://coffeeologyblog.com/choosing-the-right-roast-for-coffee-machines-3/', title: 'Choosing the Right Roast for Coffee Machines' }, { url: 'https://coffeeologyblog.com/comparing-coffee-beans-for-french-press-2/', title: 'Comparing Coffee Beans for French Press' }, { url: 'https://coffeeologyblog.com/best-5-coffee-beans-for-home-brewing-excellence-2/', title: 'Best 5 Coffee Beans for Home Brewing Excellence' }, { url: 'https://coffeeologyblog.com/organic-coffee-beans-for-coffee-makers-2/', title: 'Organic Coffee Beans for Coffee Makers' }, { url: 'https://coffeeologyblog.com/organic-coffee-beans-for-coffee-makers/', title: 'Organic Coffee Beans for Coffee Makers' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-barista-excellence/', title: 'Best Coffee Beans for Barista Excellence' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-french-press-comparison/', title: 'Best Coffee Beans for French Press Comparison' }, { url: 'https://coffeeologyblog.com/arabica-versus-robusta-for-espresso-machines-2/', title: 'Arabica Versus Robusta for Espresso Machines' }, { url: 'https://coffeeologyblog.com/arabica-versus-robusta-for-espresso-machines/', title: 'Arabica Versus Robusta for Espresso Machines' }, { url: 'https://coffeeologyblog.com/freshly-ground-coffee-beans-for-home-use/', title: 'Freshly Ground Coffee Beans for Home Use' }, { url: 'https://coffeeologyblog.com/arabica-versus-robusta-for-espresso-machines-3/', title: 'Arabica Versus Robusta for Espresso Machines' }, { url: 'https://coffeeologyblog.com/best-top-rated-coffee-beans-for-barista-excellence/', title: 'Best Top Rated Coffee Beans for Barista Excellence' }, { url: 'https://coffeeologyblog.com/is-coffee-good-for-sore-throat/', title: 'Is Coffee Good for Sore Throat?' }, { url: 'https://coffeeologyblog.com/can-i-drink-cold-coffee-after-tooth-extraction/', title: 'Can I Drink Cold Coffee After Tooth Extraction?' }, { url: 'https://coffeeologyblog.com/why-does-a-poor-man-drink-coffee/', title: 'Why Does a Poor Man Drink Coffee?' }, { url: 'https://coffeeologyblog.com/how-many-tablespoons-coffee-for-8-cups/', title: 'How Many Tablespoons Coffee for 8 Cups?' }, { url: 'https://coffeeologyblog.com/how-do-you-like-your-coffee/', title: 'How Do You Like Your Coffee?' }, { url: 'https://coffeeologyblog.com/how-much-caffeine-in-coffee-ice-cream/', title: 'How Much Caffeine in Coffee Ice Cream?' }, { url: 'https://coffeeologyblog.com/how-much-caffeine-in-half-caff-coffee/', title: 'How Much Caffeine in Half Caff Coffee?' }, { url: 'https://coffeeologyblog.com/can-you-use-powdered-sugar-in-coffee/', title: 'Can You Use Powdered Sugar in Coffee?' }, { url: 'https://coffeeologyblog.com/can-you-make-tea-in-a-coffee-maker/', title: 'Can You Make Tea in a Coffee Maker?' }, { url: 'https://coffeeologyblog.com/does-coffee-make-you-hungry/', title: 'Does Coffee Make You Hungry?' }, { url: 'https://coffeeologyblog.com/how-to-clean-a-keurig-coffee-maker/', title: 'How to Clean a Keurig Coffee Maker' }, { url: 'https://coffeeologyblog.com/how-many-ounces-in-a-cup-of-coffee/', title: 'How Many Ounces in a Cup of Coffee?' }, { url: 'https://coffeeologyblog.com/how-to-make-pour-over-coffee/', title: 'How to Make Pour Over Coffee' }, { url: 'https://coffeeologyblog.com/how-to-make-iced-coffee-at-home/', title: 'How to Make Iced Coffee at Home' }, { url: 'https://coffeeologyblog.com/how-to-clean-coffee-maker/', title: 'How to Clean Coffee Maker' }, { url: 'https://coffeeologyblog.com/how-much-caffeine-in-decaf-coffee/', title: 'How Much Caffeine in Decaf Coffee?' }, { url: 'https://coffeeologyblog.com/how-to-make-cold-brew-coffee/', title: 'How to Make Cold Brew Coffee' }, { url: 'https://coffeeologyblog.com/does-decaf-coffee-have-caffeine/', title: 'Does Decaf Coffee Have Caffeine?' }, { url: 'https://coffeeologyblog.com/how-to-make-iced-coffee/', title: 'How to Make Iced Coffee' }, { url: 'https://coffeeologyblog.com/how-to-clean-cuisinart-coffee-maker/', title: 'How to Clean Cuisinart Coffee Maker' }, { url: 'https://coffeeologyblog.com/how-to-cold-brew-coffee/', title: 'How to Cold Brew Coffee' }, { url: 'https://coffeeologyblog.com/how-to-make-turkish-coffee/', title: 'How to Make Turkish Coffee' }, { url: 'https://coffeeologyblog.com/how-to-clean-coffee-maker-with-vinegar/', title: 'How to Clean Coffee Maker with Vinegar' }, { url: 'https://coffeeologyblog.com/how-much-coffee-is-too-much/', title: 'How Much Coffee is Too Much?' }, { url: 'https://coffeeologyblog.com/what-is-a-flat-white-coffee/', title: 'What is a Flat White Coffee?' }, { url: 'https://coffeeologyblog.com/how-to-use-a-french-press-coffee-maker/', title: 'How to Use a French Press Coffee Maker' }, { url: 'https://coffeeologyblog.com/does-coffee-ice-cream-have-caffeine/', title: 'Does Coffee Ice Cream Have Caffeine?' }, { url: 'https://coffeeologyblog.com/what-makes-the-perfect-cup-of-coffee/', title: 'What Makes the Perfect Cup of Coffee?' }, { url: 'https://coffeeologyblog.com/how-to-descale-a-keurig-coffee-maker/', title: 'How to Descale a Keurig Coffee Maker' }, { url: 'https://coffeeologyblog.com/how-to-grind-coffee-beans-without-a-machine/', title: 'How to Grind Coffee Beans Without a Machine' }, { url: 'https://coffeeologyblog.com/manual-vs-electric-coffee-bean-grinders/', title: 'Manual vs Electric Coffee Bean Grinders' }, { url: 'https://coffeeologyblog.com/best-water-for-keurig-coffee-maker/', title: 'Best Water for Keurig Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-coffee-creamer-for-high-cholesterol/', title: 'Best Coffee Creamer for High Cholesterol' }, { url: 'https://coffeeologyblog.com/best-coffee-creamers-for-diabetics/', title: 'Best Coffee Creamers for Diabetics' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-under-50/', title: 'Best Coffee Maker Under $50' }, { url: 'https://coffeeologyblog.com/best-coffee-for-people-who-dont-like-coffee/', title: 'Best Coffee for People Who Don\'t Like Coffee' }, { url: 'https://coffeeologyblog.com/best-coffee-grinder-under-100/', title: 'Best Coffee Grinder Under $100' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-perfect-cappuccino/', title: 'Best Coffee Beans for Perfect Cappuccino' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-latte/', title: 'Best Coffee Beans for Latte' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-superautomatic-espresso-machines/', title: 'Best Coffee Beans for Superautomatic Espresso Machines' }, { url: 'https://coffeeologyblog.com/best-nespresso-pods-for-iced-coffee/', title: 'Best Nespresso Pods for Iced Coffee' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-jura-machines/', title: 'Best Coffee Beans for Jura Machines' }, { url: 'https://coffeeologyblog.com/best-non-oily-coffee-beans-for-superautomatic/', title: 'Best Non-Oily Coffee Beans for Superautomatic' }, { url: 'https://coffeeologyblog.com/best-coffee-grinder-for-aeropress/', title: 'Best Coffee Grinder for Aeropress' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-airbnb/', title: 'Best Coffee Maker for Airbnb' }, { url: 'https://coffeeologyblog.com/best-coffee-roaster-machine-for-small-business/', title: 'Best Coffee Roaster Machine for Small Business' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-breville-barista-express/', title: 'Best Coffee Beans for Breville Barista Express' }, { url: 'https://coffeeologyblog.com/best-coffee-for-moccamaster/', title: 'Best Coffee for Moccamaster' }, { url: 'https://coffeeologyblog.com/best-highlander-grogg-coffee/', title: 'Best Highlander Grogg Coffee' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-elderly/', title: 'Best Coffee Maker for Elderly' }, { url: 'https://coffeeologyblog.com/best-peppermint-coffee/', title: 'Best Peppermint Coffee' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-breville-2/', title: 'Best Coffee Beans for Breville' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-vacation-rental/', title: 'Best Coffee Maker for Vacation Rental' }, { url: 'https://coffeeologyblog.com/best-coffee-beans-for-chemex/', title: 'Best Coffee Beans for Chemex' }, { url: 'https://coffeeologyblog.com/best-chocolate-raspberry-coffee/', title: 'Best Chocolate Raspberry Coffee' }, { url: 'https://coffeeologyblog.com/best-keurig-pods-for-iced-coffee/', title: 'Best Keurig Pods for Iced Coffee' }, { url: 'https://coffeeologyblog.com/best-coffee-for-athletes/', title: 'Best Coffee for Athletes' }, { url: 'https://coffeeologyblog.com/best-coffee-creamer-for-mediterranean-diet/', title: 'Best Coffee Creamer for Mediterranean Diet' }, { url: 'https://coffeeologyblog.com/best-coffee-for-runners-2/', title: 'Best Coffee for Runners' }, { url: 'https://coffeeologyblog.com/best-performance-coffee-for-athletes/', title: 'Best Performance Coffee for Athletes' }, { url: 'https://coffeeologyblog.com/best-coffee-for-office/', title: 'Best Coffee for Office' }, { url: 'https://coffeeologyblog.com/best-coffee-for-french-press/', title: 'Best Coffee for French Press' }, { url: 'https://coffeeologyblog.com/best-gluten-free-coffee-creamer/', title: 'Best Gluten Free Coffee Creamer' }, { url: 'https://coffeeologyblog.com/best-prosumer-espresso-machine-under-1000/', title: 'Best Prosumer Espresso Machine Under $1000' }, { url: 'https://coffeeologyblog.com/best-prosumer-espresso-machine/', title: 'Best Prosumer Espresso Machine' }, { url: 'https://coffeeologyblog.com/best-espresso-machine-under-300/', title: 'Best Espresso Machine Under $300' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-a-small-office/', title: 'Best Coffee Maker for a Small Office' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-dunkin-donuts/', title: 'Best Coffee Maker for Dunkin Donuts' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-dementia-patients/', title: 'Best Coffee Maker for Dementia Patients' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-a-dorm-room/', title: 'Best Coffee Maker for a Dorm Room' }, { url: 'https://coffeeologyblog.com/best-coffee-vending-machine/', title: 'Best Coffee Vending Machine' }, { url: 'https://coffeeologyblog.com/best-green-coffee-beans-for-light-roast/', title: 'Best Green Coffee Beans for Light Roast' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-induction-hob/', title: 'Best Coffee Maker for Induction Hob' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-frappuccino/', title: 'Best Coffee Maker for Frappuccino' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-food-truck/', title: 'Best Coffee Maker for Food Truck' }, { url: 'https://coffeeologyblog.com/best-arabica-and-robusta-beans-for-espresso-machines/', title: 'Best Arabica and Robusta Beans for Espresso Machines' }, { url: 'https://coffeeologyblog.com/best-freshly-ground-coffee-beans-for-home/', title: 'Best Freshly Ground Coffee Beans for Home' }, { url: 'https://coffeeologyblog.com/best-5-budget-friendly-espresso-coffee-machines/', title: 'Best 5 Budget Friendly Espresso Coffee Machines' }, { url: 'https://coffeeologyblog.com/best-7-home-coffee-machine-types-for-brew-lovers/', title: 'Best 7 Home Coffee Machine Types for Brew Lovers' }, { url: 'https://coffeeologyblog.com/best-integrated-grinder-coffee-machines-for-bean-lovers/', title: 'Best Integrated Grinder Coffee Machines for Bean Lovers' }, { url: 'https://coffeeologyblog.com/best-dual-coffee-maker-with-k-cup-2/', title: 'Best Dual Coffee Maker with K-Cup' }, { url: 'https://coffeeologyblog.com/best-environmentally-friendly-coffee-maker/', title: 'Best Environmentally Friendly Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-that-makes-thecoffee/', title: 'Best Coffee Maker That Makes the Coffee' }, { url: 'https://coffeeologyblog.com/best-non-toxic-coffee-maker-2/', title: 'Best Non Toxic Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-plastic-free-coffee-maker/', title: 'Best Plastic Free Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-with-milk-frother/', title: 'Best Coffee Maker with Milk Frother' }, { url: 'https://coffeeologyblog.com/best-coffee-for-mr-coffee-iced-coffee-maker/', title: 'Best Coffee for Mr Coffee Iced Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-bpa-free-coffee-maker/', title: 'Best BPA Free Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-single-serve-coffee-machines/', title: 'Best Single Serve Coffee Machines' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-5-cup/', title: 'Best Coffee Maker 5 Cup' }, { url: 'https://coffeeologyblog.com/best-costco-coffee-maker/', title: 'Best Costco Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-5-cup-coffee-maker-2022/', title: 'Best 5 Cup Coffee Maker 2022' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-ninja/', title: 'Best Coffee Maker Ninja' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-with-k-cup-combo/', title: 'Best Coffee Maker with K-Cup Combo' }, { url: 'https://coffeeologyblog.com/best-italian-coffee-maker/', title: 'Best Italian Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-white-coffee-maker/', title: 'Best White Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-turkish-coffee-maker/', title: 'Best Turkish Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-cuban-coffee-maker/', title: 'Best Cuban Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-under-100/', title: 'Best Coffee Maker Under $100' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-hard-water/', title: 'Best Coffee Maker for Hard Water' }, { url: 'https://coffeeologyblog.com/best-coffee-for-cold-brew-maker/', title: 'Best Coffee for Cold Brew Maker' }, { url: 'https://coffeeologyblog.com/best-non-toxic-coffee-maker/', title: 'Best Non Toxic Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-scaa-coffee-maker/', title: 'Best SCAA Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-plumbed-coffee-maker/', title: 'Best Plumbed Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-battery-operated-coffee-maker/', title: 'Best Battery Operated Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-rv/', title: 'Best Coffee Maker for RV' }, { url: 'https://coffeeologyblog.com/best-dorm-coffee-maker/', title: 'Best Dorm Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-nitro-cold-brew-coffee-maker/', title: 'Best Nitro Cold Brew Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-5-drip-coffee-machines/', title: 'Best 5 Drip Coffee Machines' }, { url: 'https://coffeeologyblog.com/best-dual-coffee-maker-with-k-cup/', title: 'Best Dual Coffee Maker with K-Cup' }, { url: 'https://coffeeologyblog.com/best-coffee-machine-to-make-starbucks-at-home/', title: 'Best Coffee Machine to Make Starbucks at Home' }, { url: 'https://coffeeologyblog.com/best-coffee-makers-with-water-line-hookup/', title: 'Best Coffee Makers with Water Line Hookup' }, { url: 'https://coffeeologyblog.com/best-cheap-espresso-machines/', title: 'Best Cheap Espresso Machines' }, { url: 'https://coffeeologyblog.com/best-pour-over-automatic-coffee-maker/', title: 'Best Pour Over Automatic Coffee Maker' }, { url: 'https://coffeeologyblog.com/best-coffee-maker-for-wedding-registry/', title: 'Best Coffee Maker for Wedding Registry' }, { url: 'https://coffeeologyblog.com/best-lavazza-coffee-products-you-must-try-in-2025/', title: 'Best Lavazza Coffee Products You Must Try in 2025' }, { url: 'https://coffeeologyblog.com/lavazza-expert-coffee-classy-plus-review/', title: 'Lavazza Expert Coffee Classy Plus Review' }];
        let conversationHistory = [];

        // --- IMPROVED SEARCH FUNCTION ---
        function searchSitemap(query) {
            const stopWords = new Set(['a', 'an', 'the', 'is', 'are', 'was', 'were', 'for', 'to', 'of', 'in', 'on', 'at', 'with', 'by', 'about', 'how', 'what', 'when', 'where', 'why', 'and', 'or', 'but', 'if', 'you', 'your']);
            
            const queryLower = query.toLowerCase().replace(/[^\w\s]/gi, '');
            const queryWords = queryLower.split(/\s+/).filter(word => !stopWords.has(word) && word.length > 2);

            const results = SITEMAP.map(item => {
                const titleLower = item.title.toLowerCase();
                let score = 0;

                queryWords.forEach(word => {
                    if (titleLower.includes(word)) {
                        score += 10; // High score for each important word match
                    }
                });
                
                // Bonus for exact phrase match in title
                if (titleLower.includes(queryWords.join(' '))) {
                    score += 20;
                }

                return { ...item, score };
            })
            .filter(item => item.score > 0)
            .sort((a, b) => b.score - a.score);
            
            return results.slice(0, 2); // Return top 2 results
        }

        // --- DOM AND EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            const launcher = document.getElementById('chat-launcher');
            const widget = document.getElementById('chat-widget-container');
            const closeBtn = document.getElementById('close-widget-btn');
            
            launcher.addEventListener('click', () => widget.classList.toggle('active'));
            closeBtn.addEventListener('click', () => widget.classList.remove('active'));
            
            addInitialMessages();
        });

        // --- CORE CHAT FUNCTIONS ---
        async function processMessage(message) {
            conversationHistory.push({ role: 'user', content: message });
            
            const relevantArticles = searchSitemap(message);

            try {
                const response = await fetch('/.netlify/functions/ask-coffee-bot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        conversation: [
                            { role: 'system', content: 'You are a coffee expert for Coffeeology blog. Keep responses concise and helpful. You must answer the user\'s question first, and then, if relevant articles are provided, smoothly transition to recommending them.'},
                            ...conversationHistory.slice(-5)
                        ]
                    })
                });
                
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                let aiResponse = data.choices[0].message.content;
                
                // Append recommendations to the response
                aiResponse += formatArticleRecommendations(relevantArticles);

                conversationHistory.push({ role: 'assistant', content: aiResponse });
                removeTypingIndicator();
                addMessage(aiResponse, 'bot');
                
            } catch (error) {
                removeTypingIndicator();
                addMessage("Sorry, I'm having a little trouble connecting. Please try again.", 'bot');
            }
        }
        
        function formatArticleRecommendations(articles) {
            if (!articles || articles.length === 0) return '';
            
            let html = '<div class="mt-4"><p class="font-semibold mb-2 text-white">Recommended Articles:</p>';
            articles.forEach(article => {
                html += `
                    <div class="article-card p-3 mb-2 rounded-lg text-sm">
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer">
                            <i class="fas fa-external-link-alt mr-2"></i>${article.title}
                        </a>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function handleKeyPress(event) { if (event.key === 'Enter') sendMessage(); }
        
        function sendMessage() { 
            const input = document.getElementById('userInput'); 
            const message = input.value.trim(); 
            if (!message) return; 
            addMessage(message, 'user'); 
            input.value = ''; 
            showTypingIndicator(); 
            processMessage(message); 
        }

        function addMessage(text, sender) { 
            const messagesContainer = document.getElementById('chatMessages'); 
            const messageDiv = document.createElement('div'); 
            messageDiv.className = `flex items-start space-x-3 mb-4 ${sender === 'user' ? 'justify-end' : ''}`; 
            const avatarHtml = `<div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${sender === 'user' ? 'bg-gradient-to-r from-blue-500 to-purple-500 order-2' : 'bg-gradient-to-r from-pink-400 to-red-400'}"><i class="fas fa-${sender === 'user' ? 'user' : 'robot'} text-white text-sm"></i></div>`; 
            const bubble = document.createElement('div'); 
            bubble.className = `message-bubble ${sender === 'user' ? 'user-message' : 'bot-message'} rounded-lg p-3 shadow-md`; 
            bubble.innerHTML = `<div class="text-sm">${text.replace(/\n/g, '<br>')}</div>`;
            messageDiv.innerHTML = sender === 'user' ? bubble.outerHTML + avatarHtml : avatarHtml + bubble.outerHTML; 
            messagesContainer.appendChild(messageDiv); 
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
        }

        function showTypingIndicator() { 
            const messagesContainer = document.getElementById('chatMessages'); 
            const typingDiv = document.createElement('div'); 
            typingDiv.id = 'typingIndicator'; 
            typingDiv.className = 'flex items-start space-x-3 mb-4'; 
            typingDiv.innerHTML = `<div class="w-8 h-8 bg-gradient-to-r from-pink-400 to-red-400 rounded-full flex items-center justify-center flex-shrink-0"><i class="fas fa-robot text-white text-sm"></i></div><div class="message-bubble bot-message rounded-lg p-3 shadow-md">...</div>`; 
            messagesContainer.appendChild(typingDiv); 
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
        }

        function removeTypingIndicator() { 
            const indicator = document.getElementById('typingIndicator'); 
            if (indicator) indicator.remove(); 
        }
        
        function addInitialMessages() { 
            addMessage("Hi! I'm your guide to the world of coffee. How can I help?", 'bot'); 
        }
    </script>
</body>
</html>